<!doctype html>
<div class="row">
    <div class="col">
        <select id="main_filter" 
            class="selectpicker mt-1"
            title="Choose the diseases to be shown..." 
            data-style="btn-info"
            data-width="auto"
            data-header="Select the diseases to be shown..."
            data-actions-box="true"
            multiple 
            data-live-search="true"
            data-live-search-normalize="true"
            data-live-search-style="contains"
            data-live-search-placeholder="type disease number or part of the name..."
            data-selected-text-format="count">
        </select>
    </div>
    <div id="main-filter-loading-indicator" class="notloading">Will reload...</div>
    <div class="col text-right">
        <div id="total_total"></div>
        <div id="total_kebele"></div>
        <div id="total_woreda"></div>
        <div id="total_unknown"></div>
        <div id="total_ipd"></div>
        <div id="total_opd"></div>
    </div>
</div>

<script type="text/javascript">

    /*
     * WHO Priority Diseases
     *
     * Missing codes for:
     * - Chikungunya
     * - Plague
     * - Rift Valley Fever
     * - Marburg
     * - Buruli Ulcer
     * - Noma
     * - Adverse events following immunization (AEFI)
     * - Trypanosomiasis
     * 
     * Arbitrary Excluded (there are multiple definitions):
     * - All type of Diabetes
     * - All type of HIV/AIDS (new cases)
     * - All type of Hypertension
     * - All type of Injuries
     * - All type of Malaria
     * - All type of Malnutrition
     * - All type of Maternal Deaths 
     * - All type of Mental health
     * - All type of Pneumonia
     * - All type of Trachoma
     * - All type of Tuberculosis
     * 
     * current resultset:
     * 1 - Cholera
     * 8 - Diarrhea (Shigellosis due to Shigella dysenteriae)
     * 55 - Anthrax
     * 56 - Leprosy (Tuberculoid leprosy)
     * 57 - Leprosy (Borderline leprosy)
     * 58 - Leprosy (Lepromatous leprosy)
     * 59 - Leprosy (Leprosy, unspecified)
     * 61 - Tetanus (Tetanus neonatorum)
     * 64 - Meningitis (Meningococcal meningitis)
     * 110 - Typhus fever
     * 111 - Typhus fever (Epidemic louse-borne typhus fever due to Rickettsia prowazekii)
     * 112 - Typhus fever, unspecified
     * 113 - Poliomyelitis (Acute poliomyelitis)
     * 114 - Poliomyelitis (Acute paralytic poliomyelitis, vaccine-associated)
     * 115 - Acute paralytic poliomyelitis, wild virus, imported
     * 116 - Acute paralytic poliomyelitis, wild virus, indigenous
     * 117 - Poliomyelitis (Acute nonparalytic poliomyelitis)
     * 118 - Acute poliomyelitis, unspecified
     * 119 - Rabies (Rabies, unspecified)
     * 120 - Haemorrhagic Fevers (Dengue fever [classical dengue])
     * 122 - Haemorrhagic Fevers (Yellow fever)
     * 125 - Ebola (Other specified viral haemorrhagic fevers)
     * 137 - Smallpox
     * 138 - Measles
     * 139 - Measles (Measles with other complications)
     * 140 - Measles (Measles without complication)
     * 146 - Hepatitis (Acute viral hepatitis, unspecified)
     * 147 - Hepatitis (Chronic viral hepatitis)
     * 148 - Hepatitis C (Other chronic viral hepatitis)
     * 205 - Dracunculiasis (Guinea worm)
     * 206 - Onchocerciasis
     * 207 - Filariasis
     * 208 - Elephantiasis (Filariasis due to Wuchereria bancrofti)
     * 228 - Poliomyelitis (Sequelae of poliomyelitis)
     * 229 - Leprosy (Sequelae of leprosy)
     * 634 - Avian influenza-h5n1 (Other acute upper respiratory infections)
     * 635 - Pandemic influenza A-h1n1 (Other acute upper respiratory infections of multiple sites)
     * 636 - Respiratory Infection (Acute upper respiratory infection, unspecified)
     * 637 - Influenza (Influenza, virus not identified)
     * 1848 - Severe acute respiratory syndrome [SARS]
     */ 
    var who_diseases_list = [55,1,120,8,138,139,140,64,634,635,636,637,110,111,112,122,125,205,229,56,57,58,59,207,208,61,206,113,114,115,116,117,118,228,137,1848,146,147,148,119];

    /**
     * SARS-CoV-2 (and similar)
     *
     * current resultset:
     * 2.1 - Covid Suspect
     * 2.2 - Covid Positive
     * 634 - Avian influenza-h5n1 (Other acute upper respiratory infections)
     * 635 - Pandemic influenza A-h1n1 (Other acute upper respiratory infections of multiple sites)
     * 636 - Respiratory Infection (Acute upper respiratory infection, unspecified)
     * 637 - Influenza (Influenza, virus not identified)
     * 638 - Pneumonia (Bacterial pneumonia, unspecified)
     * 639 - Pneumonia (Bronchopneumonia, unspecified)
     * 640 - Pneumonia (Lobar pneumonia, unspecified)
     * 641 - severe pneumonia (Other pneumonia, organism unspecified)
     * 642 - Pneumonia (Pneumonia, unspecified)
     * 643 - Bronchitis (Acute bronchitis)
     * 644 - Respiratory Infections (Unspecified acute lower respiratory infection)
     * 645 - Tonsillitis & Adenoiditis (Chronic tonsillitis)
     * 646 - Peritonsillar abscess
     * 647 - Bronchitis, not specified as acute or chronic
     * 648 - Emphysema
     * 649 - Asthma
     * 650 - Bronchiectasis
     * 651 - Adult respiratory distress syndrome
     * 652 - Pulmonary oedema
     * 654 - Pneumonia (Pneumothorax)
     * 657 - Respiratory Failure (Respiratory failure, unspecified)
     * Y2016-066.1 - Asthma
     * Y2016-088 - Influenza
     * Y2016-089 - Lobar pneumonia
     * Y2016-090 - Bronchopneumonia
     * Y2016-091 - Other pneumonia
     * Y2016-091.01 - PCP
     * Y2016-092 - acute bronchitis
     * Y2016-093 - chronic bronchitis
     * Y2016-093.01 - COPD
     * Y2016-093.02 - Pulmonary fibrosis
     */
    var covid_diseases_list = [2.1,2.2,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,654,657,'Y2016-066.1','Y2016-088','Y2016-089','Y2016-090','Y2016-091','Y2016-091.01','Y2016-092','Y2016-093','Y2016-093.01','Y2016-093.02'];

    /**
     * 1B10.0 - Respiratory tuberculosis, confirmed
     * 1B10.1 - Respiratory tuberculosis, not confirmed
     * 1B11.0 - Tuberculous meningitis
     * 1B11.3 - Tuberculous granuloma of brain
     * 1B11.Z - Tuberculosis of the nervous system, unspecified
     * 1B12.4 - Tuberculosis of the musculoskeletal system
     * 1B12.5 - Tuberculosis of the genitourinary system
     * 1B12.6 - Tuberculous peripheral lymphadenopathy
     * 1B12.7 - Tuberculosis of the digestive system
     * 1B12.Y - Tuberculosis of other specified organ or site
     * 1B13 - Miliary tuberculosis
     * 1B14 - Latent tuberculosis
     * 1B1Z - Tuberculosis, unspecified
     * 1C60 - Human immunodeficiency virus disease associated with tuberculosis
     * 1C62 - Human immunodeficiency virus disease without mention of tuberculosis or malaria
     * KA61.0 - Congenital tuberculosis
     */
    var tuberculosis_disease_list = ['1B10.0','1B10.1','1B11.0','1B11.3','1B11.Z','1B12.4','1B12.5','1B12.6','1B12.7','1B12.Y','1B13','1B14','1B1Z','1C60','1C62','KA61.0'];

    var main_filter_total_total = 0;
    var main_filter_total_kebele = 0;
    var main_filter_total_woreda = 0;
    var main_filter_total_unknown = 0;
    var main_filter_total_opd = 0;
    var main_filter_total_ipd = 0;
    var first_total_badge;
    var first_kebele_badge;
    var first_woreda_badge;
    var first_unknown_badge;
    var first_opd_badge;
    var first_ipd_badge;

    var update_main_filter = false;

    function updateMainFilterTotals(opdColor, ipdColor) {
        //resetMainFilterTotals();
        var total_total = document.getElementById("total_total");
        var total_kebele = document.getElementById("total_kebele");
        var total_woreda = document.getElementById("total_woreda");
        var total_unknown = document.getElementById("total_unknown");
        var total_opd = document.getElementById("total_opd");
        var total_ipd = document.getElementById("total_ipd");
        
        total_total.setAttribute('class',"badge badge-secondary badge-pill ml-auto p-2 float-xs-right");
        total_total.setAttribute('style',"border-style:solid;color:#007bff;background-color:#ffffff");
        total_opd.setAttribute('class',"badge badge-secondary badge-pill ml-auto p-2 float-xs-right");
        total_opd.setAttribute('style',"color:#fff;background-color:" + opdColor);
        total_ipd.setAttribute('class',"badge badge-secondary badge-pill ml-auto p-2 float-xs-right");
        total_ipd.setAttribute('style',"color:#fff;background-color:" + ipdColor);

        //console.log('first_total_badge : ', first_total_badge);
        //console.log('first_kebele_badge : ', first_kebele_badge);
        //console.log('first_woreda_badge : ', first_woreda_badge);
        //console.log('first_unknown_badge : ', first_unknown_badge);
        //console.log('first_opd_badge : ', first_opd_badge);
        //console.log('first_ipd_badge : ', first_ipd_badge);

        $('#total_total').empty();
        $('#total_kebele').empty();
        $('#total_woreda').empty();
        $('#total_unknown').empty();
        $('#total_opd').empty();
        $('#total_ipd').empty();

        //TODO: optimize badge positions calculation: maybe there is a better way to layout badges one beside each other
        if (main_filter_total_total > 0) {
            total_total.appendChild(document.createTextNode("T: " + main_filter_total_total));
            $("#total_total").position({
                my:        "right",
                at:        "right",
                of:        first_total_badge,
                collision: "fit"
            });
            $("#total_total").css('top', 10);
        }
        //console.log('main_filter_total_ipd : ' + main_filter_total_ipd)
        if (main_filter_total_ipd > 0) {
            total_ipd.appendChild(document.createTextNode("IPD: " + main_filter_total_ipd));
            $("#total_ipd").position({
                my:        "right",
                at:        "left",
                of:        total_total,
                collision: "fit"
            });
            $("#total_ipd").css('top', 10);
        }
        //console.log('main_filter_total_opd : ' + main_filter_total_opd)
        if (main_filter_total_opd > 0) {
            total_opd.appendChild(document.createTextNode("OPD: " + main_filter_total_opd));
            if (main_filter_total_ipd > 0) {
                $("#total_opd").position({
                    my:        "right",
                    at:        "left",
                    of:        total_ipd,
                    collision: "fit"
                });
                $("#total_opd").css('top', 10);
            } else {
                $("#total_opd").position({
                    my:        "right",
                    at:        "left",
                    of:        total_total,
                    collision: "fit"
                });
                $("#total_opd").css('top', 10);
            }
        }
        // if (main_filter_total_unknown > 0) {
        //     total_unknown.appendChild(document.createTextNode(main_filter_total_unknown));
        //     if (main_filter_total_woreda > 0) {
        //         $("#total_unknown").position({
        //             my:        "right",
        //             at:        "left",
        //             of:        total_woreda,
        //             collision: "fit"
        //         });
        //     } else if (main_filter_total_kebele > 0) {
        //         $("#total_unknown").position({
        //             my:        "right",
        //             at:        "left",
        //             of:        total_kebele,
        //             collision: "fit"
        //         });
        //     } else {
        //         $("#total_unknown").position({
        //             my:        "center",
        //             at:        "center",
        //             of:        total_total,
        //             collision: "fit"
        //         });
        //     }
        //     $("#total_unknown").css('top', 10);
        // }
    }

    function resetMainFilterTotals() {
        $('#total_total').empty();
        $('#total_kebele').empty();
        $('#total_woreda').empty();
        $('#total_unknown').empty();
        $('#total_opd').empty();
        $('#total_ipd').empty();
        main_filter_total_total = 0;
        main_filter_total_kebele = 0;
        main_filter_total_woreda = 0;
        main_filter_total_unknown = 0;
        main_filter_total_opd = 0;
        main_filter_total_ipd = 0;
        first_total_badge = undefined;
        first_kebele_badge = undefined;
        first_woreda_badge = undefined;
        first_unknown_badge = undefined;
        first_opd_badge = undefined;
        first_ipd_badge = undefined;
    }

    /*
     * (function) Make option item for the filter
     */
    function main_filter_make_option(value, text) {
        return '<option value="'+value+'">'+text.substring(0, 50)+'</option>';
    }

    /*
     * (function) Make option 'disabled' item (title) for the filter
     */
     function main_filter_make_option_selected(value, text) {
        return '<option selected value="'+value+'">'+text.substring(0, 50)+'</option>';
    }

    /*
     * (function) Reset the main filter
     */
    function reset_main_filter() {
        main_filter = $("#main_filter");
        main_filter.find('option').remove().end();
        all_diseases_count = diseases.length;
        who_diseases_count = who_diseases_list.length;
        covid_diseases_count = covid_diseases_list.length;
        tuberculosis_diseases_count = tuberculosis_disease_list.length;

        //TODO: add pre-set filters
        // main_filter.append(main_filter_make_option('Clear','Clear all'));
        // main_filter.append(main_filter_make_option('All','Select all ('+all_diseases_count+')'));
        main_filter.append(main_filter_make_option('WHO','WHO Priority Diseases ('+who_diseases_count+')'));
        main_filter.append(main_filter_make_option('COVID','SARS-CoV-2 ('+covid_diseases_count+')'));
        main_filter.append(main_filter_make_option('TB','Tuberculosis ('+tuberculosis_diseases_count+')'));
        //main_filter.append(main_filter_make_option('TopTen','Top Ten Diseases (10)'));
        main_filter.append('<option id="data-divider" data-divider="true"></option>');
        
        diseases.forEach(function (item, index) {
            main_filter.append(main_filter_make_option(item.DIS_ID_A,item.DIS_DESC));
            //console.log(item);
        });
        main_filter.selectpicker('refresh');
    }
    
    /*
     * (event) when the change the filter selection
     */
    $('#main_filter').on("changed.bs.select", function(e, clickedIndex, newValue, oldValue) {
        $('#main-filter-loading-indicator').attr("class","loading");
        update_main_filter = true;
        var selected = $('#main_filter').val();
        // var lastSelected = $(this).find('option').eq(clickedIndex).val();
        // console.log('selected : ' + selected); //Get the multiple values selected in an array
        // console.log(selected.length); //Length of the array
        // console.log('last : ' + lastSelected);

        if (selected == "WHO") disease_list_filter = who_diseases_list
        else if (selected == "COVID") disease_list_filter = covid_diseases_list
        else if (selected == "TB") disease_list_filter = tuberculosis_disease_list

        else disease_list_filter = selected;
        //console.log('disease_list_filter : ' + disease_list_filter);
    });

    /*
     * (event) called when the user clicks outside the dropdown
     */
    $('#main_filter').on("hide.bs.select", function(e, clickedIndex, newValue, oldValue) {
        //console.log(e);
    });

    /*
     * (event) when the dropdown disappear the filtering can start
     */
    $('#main_filter').on("hidden.bs.select", function(e, clickedIndex, newValue, oldValue) {
        if (update_main_filter) {
            udpate_main_filter();
            refresh(true);
            update_main_filter = false;
            $('#main-filter-loading-indicator').attr("class","notloading");
        }
    });

    /*
     * (function) Update main filter
     */
    function udpate_main_filter() {
        console.log('updating filter...');
        reset_main_filter();
        main_filter = $("#main_filter");
        if (disease_list_filter.length > 0) {
            selected_options = filterFast(diseases, disease_list_filter, 'DIS_ID_A');
            //console.log('selected_options : ' + selected_options);
            selected_options.forEach(function (item, index) {
                main_filter.find('[value="'+item.DIS_ID_A+'"]').remove();
                main_filter.find('[id="data-divider"]').before(main_filter_make_option_selected(item.DIS_ID_A,item.DIS_DESC));
            });
            main_filter.selectpicker('refresh');
        } 
    }
</script>